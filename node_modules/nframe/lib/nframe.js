
http = require('./http');

exports = module.exports;
var server;

var modules = {'res':undefined, 'global':undefined};

exports.createServer = function(cb) {
	server = http.createServer();
	loadModules(function(){
		cb(selector);
	});
};

loadModules = function(cb) {
	server.on('request', function(req, res) {
		for(var i in modules){
			var module = require('./' + i);
			modules[i] = module;
		}
		for(var i in modules){
			modules[i].setModules(modules);
			modules[i].set(req, res);
		}
		cb();
	});
}

selector = function(name) {
	return modules[name];
};

exports.listen = function(port, hostname, backlog, cb){
	http.listen(port, hostname, backlog, cb);
};